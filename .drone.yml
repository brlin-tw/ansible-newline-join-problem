kind: pipeline
type: docker
name: åŸºæ–¼ Docker runner çš„æµæ°´ç·š

clone:
  skip_verify: true

steps:
  - name: æŠ“å– Git æ¨™ç±¤
    image: alpine/git
    # è®“æŒçºŒæ•´åˆä¹Ÿèƒ½åœ¨æœ¬åœ°é‹è¡Œï¼ˆå®¹å™¨ä¸­ç„¡ä½¿ç”¨è€… SSH ç§é‘°ï¼‰
    failure: ignore
    commands:
      - GIT_SSL_NO_VERIFY= git fetch --tags

  - name: æŠ“å– Git å­æ¨¡çµ„
    image: alpine/git
    # è®“æŒçºŒæ•´åˆä¹Ÿèƒ½åœ¨æœ¬åœ°é‹è¡Œï¼ˆå®¹å™¨ä¸­ç„¡ä½¿ç”¨è€… SSH ç§é‘°ï¼‰
    failure: ignore
    commands:
      - GIT_SSL_NO_VERIFY= git submodule update --init

  - name: æŠ“å– Ansible ä¾è³´è³‡æº
    image: alpine:3.12
    commands:
      - ./æŒçºŒæ•´åˆ/fetch-ansible-requirements.sh

  - name: éœæ…‹ä»£ç¢¼åˆ†æ
    depends_on:
      - æŠ“å– Git æ¨™ç±¤
      - æŠ“å– Ansible ä¾è³´è³‡æº
    image: alpine:3.12
    commands:
      - ./æŒçºŒæ•´åˆ/static-code-analysis.sh

  - name: ç”¢ç”Ÿä¸¦äº¤ä»˜é‡‹å‡ºçš„è»Ÿé«”
    depends_on:
      - æŠ“å– Git æ¨™ç±¤
      - æŠ“å– Git å­æ¨¡çµ„
      - æŠ“å– Ansible ä¾è³´è³‡æº
    when:
      event:
        #- push
        - tag
    image: alpine:3.14
    environment:
      GITLAB_AUTH_TOKEN:
        from_secret: gitlab_auth_token
    commands:
      - apk add bash
      - ./æŒçºŒæ•´åˆ/deliver-built-artifacts.sh

  - name: ç™¼é€æŒçºŒæ•´åˆçµæœåˆ°å‘Šè­¦é »é“
    event:
      - push
      - pull_request
    when:
      status:
        - success
        - failure
    depends_on:
      - éœæ…‹ä»£ç¢¼åˆ†æ
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: telegram_bot_auth_token
      to: -1001613731358
      format: Markdown
      # å½é™½æ€§æª¢æŸ¥çµæœï¼šè¡Œé•·åº¦ç„¡æ³•è¼•æ˜“ç¸®æ¸›
      # yamllint disable rule:line-length
      message: |-
        **{{#success build.status}}âœ… æŒçºŒæ•´åˆ(CI)é€šé**{{else}}âŒ æŒçºŒæ•´åˆ(CI)ä¸é€šéï¼Œè«‹ç›¡å¿«ä¿®æ­£å•é¡Œ{{/success}}**

        ğŸ“–å°ˆæ¡ˆï¼š{{repo.namespace}}/{{repo.name}}
        ğŸ‹åˆ†æ”¯ï¼š{{commit.branch}}
        ğŸ‘¤ä½œè€…ï¼š{{commit.author}}
        âœ’ï¸ä¿®è¨‚ç‰ˆï¼š{{truncate commit.sha 8}}

        ```
        {{commit.message}}
        ```
        â²ï¸èŠ±è²»æ™‚é–“ï¼š{{since build.started}}
        ğŸŒå ±å‘Šé€£çµï¼š{{build.link}}
